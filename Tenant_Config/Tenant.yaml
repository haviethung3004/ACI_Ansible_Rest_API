---
- name: Create a tenant on ACI
  hosts: hostlocal
  connection: local
  gather_facts: false
  vars_files:
    - vars.yaml
  tasks:
    - name: Login to APIC and get authentication cookie
      uri:
        url: "https://{{ aci_host }}/api/aaaLogin.json"
        method: POST
        headers:
          Content-Type: "application/json"
        body: |
          {
            "aaaUser": {
              "attributes": {
                "name": "{{ aci_username }}",
                "pwd": "{{ aci_password }}"
              }
            }
          }
        body_format: json
        validate_certs: false
      register: login_result

    - name: Extract APIC Cookie
      set_fact:
        apic_cookie: "{{ login_result.cookies['APIC-cookie'] }}"
    
    - name: Create a New tenant
      uri:
        url: "https://192.168.1.250/api/node/mo/uni/tn-{{ tenant_name }}.json"
        method: POST
        headers:
          Content-Type: "application/json"
          Cookie: "APIC-Cookie={{ apic_cookie }}"
        body: |
          {
            "fvTenant": {
              "attributes": {
                "name": "{{ tenant_name }}",
                "descr": "{{ tenant_description }}"
              }
            }
          }
        body_format: json
        validate_certs: false
      register: result